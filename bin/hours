#!/usr/bin/env ruby

$LOAD_PATH.unshift File.dirname(__FILE__) + '/../lib'

require 'rubygems'
require 'trollop'
require 'expander'
require 'yaml'
require 'pp'
require 'odf-report'
require 'ruby-debug'

# Process the arguments
opts = Trollop::options do
  opt :template, 'Open Document Template to base output on', :type => :string, :required => true
  opt :hours, 'File with hours formatted in YAML',:short => 'i', :type => :io, :required => true
  opt :out_file, 'Name of outputted Open Document Format file', :type => :string
  opt :verbose, 'Display more info about steps being taken'
  opt :rate, 'global hourly rate to apply as default', :type => :int, :required => true
end

data = YAML.load(opts[:hours])
expanded = Expander.new.run(data)
pp expanded

report = ODFReport.new(opts[:template]) do |r|
  r.add_field "NUMBER", '001'
  r.add_field "RATE", opts[:rate]

  r.add_table('HOURS', expanded) do |row,i|
    row['DATE'] = i[:start].strftime('%m/%d/%y')
    time_calc = sprintf('%.2f',(i[:end] - i[:start]) / 3600)
    row['TIME'] = time_calc
    row['DESCRIPTION'] = i[:label] 
  end
end

puts report.generate
